<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Librarian Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
        }
        th {
            background: #f4f4f4;
        }
        .overdue {
            color: red;
            font-weight: bold;
        }
        .nav {
            margin-bottom: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="nav">
    <a href="/">
        <button>Back to Library</button>
    </a>
</div>

<h1>Librarian Dashboard</h1>

<h2>Popular Books</h2>
<canvas id="popularBooksChart" width="600" height="300"></canvas>

<script th:inline="javascript">
    /*<![CDATA[*/
    const stats = [[${stats}]];

    const labels = stats.map(s => s[0]);
    const data = stats.map(s => s[1]);
    /*]]>*/
</script>

<script>
    const ctx = document.getElementById('popularBooksChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Loans',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Most Borrowed Books'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
</script>
<ul>
    <li th:each="s : ${stats}">
        <span th:text="${s[0]}"></span>
        — <b th:text="${s[1]}"></b> loans
    </li>
</ul>

<h2>Overdue Loans</h2>
<table>
    <tr>
        <th>User</th>
        <th>Book</th>
        <th>Due Date</th>
        <th>Late Fee</th>
        <th>Action</th>
    </tr>

    <tr th:each="loan : ${overdue}">
        <td th:text="${loan.user.name}"></td>
        <td th:text="${loan.book.title}"></td>
        <td th:text="${loan.dueDate}"></td>
        <td>
        <span th:if="${loan.returnDate == null and loan.dueDate.isBefore(T(java.time.LocalDate).now())}">
            ️<b th:text="${T(java.time.temporal.ChronoUnit).DAYS.between(loan.dueDate, T(java.time.LocalDate).now()) * 2}"></b> RON (if returned today)
        </span>
        </td>
        <td>
            <form th:action="@{/librarian/reminder}" method="post">
                <input type="hidden" name="loanId" th:value="${loan.id}" />
                <button type="submit">Send Reminder</button>
            </form>
        </td>

    </tr>
</table>

<h2>All Books</h2>
<table>
    <tr>
        <th>Title</th>
        <th>Author</th>
        <th>Availability</th>
        <th>QR Code</th>
    </tr>

    <tr th:each="book : ${books}">
        <td th:text="${book.title}"></td>
        <td th:text="${book.author}"></td>
        <td>
            <span th:text="${book.availableCopies} + '/' + ${book.totalCopies}"></span>
        </td>
        <td>
            <img th:src="'data:image/png;base64,' + ${book.qrCode}" width="120"/>
        </td>
    </tr>
</table>

</body>
</html>
